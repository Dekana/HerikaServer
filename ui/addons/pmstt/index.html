<!DOCTYPE html>
<html>
    <head>
        <title>The poor man's STT</title>
        <style>
            #result {
                border: 2px solid black;
                height: 200px;
                border-radius: 3px;
                font-size: 14px;
                padding: 5px;
                overflow-y: auto;
            }
            .controls {
                position: absolute;
                top: 340px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                gap: 10px;
                flex-direction: column;
                align-items: center;
            }
            select, button {
                padding: 10px 20px;
                font-size: 16px;
                margin: 5px 0;
            }
        </style>
        <script>
            let speechRecognizer; // Declare variable for speech recognition
            let selectedLanguage = "en-US"; // Default language

            function start() {
                var r = document.getElementById("result");

                if ("webkitSpeechRecognition" in window) {
                    speechRecognizer = new webkitSpeechRecognition();
                    speechRecognizer.continuous = true;
                    speechRecognizer.interimResults = true;
                    speechRecognizer.lang = selectedLanguage; // Set language dynamically

                    var finalTranscripts = "";
                    var pauseTimer;

                    speechRecognizer.start();

                    speechRecognizer.onresult = function (event) {
                        var interimTranscripts = "";

                        for (var i = event.resultIndex; i < event.results.length; i++) {
                            var transcript = event.results[i][0].transcript;
                            transcript = transcript.replace("\n", "<br>");
                            if (event.results[i].isFinal) {
                                finalTranscripts += transcript;
                                sendText(finalTranscripts); // Send final text
                                finalTranscripts = ""; // Clear after sending
                            } else {
                                interimTranscripts += transcript;
                            }
                        }

                        r.innerHTML = finalTranscripts + '<span style="color: #999;">' + interimTranscripts + '</span>';

                        // Reset pause timer
                        clearTimeout(pauseTimer);
                        pauseTimer = setTimeout(() => {
                            if (finalTranscripts) {
                                sendText(finalTranscripts); // Send on longer pause
                                finalTranscripts = ""; // Clear after sending
                            }
                        }, 1000); // 1 second pause
                    };

                    speechRecognizer.onerror = function (event) {
                        console.error("Speech recognition error:", event.error);
                    };

                    speechRecognizer.onend = function () {
                        // Restart listening to keep continuous recognition
                        if (speechRecognizer) {
                            speechRecognizer.start();
                        }
                    };

                } else {
                    r.innerHTML = "Your browser does not support speech recognition.";
                }

                async function sendText(text) {
                     
                    try {
                        const url = `PlayerSays.php?speech=${encodeURIComponent(text)}`;
                        const response = await fetch(url);
                        if (response.ok) {
                            console.log("Text sent successfully:", text);
                        } else {
                            console.error("Failed to send text. HTTP Status:", response.status);
                        }
                    } catch (error) {
                        console.error("Error sending text:", error);
                    }
                }
            }

            function stop() {
                if (speechRecognizer) {
                    speechRecognizer.stop(); // Stop recognition
                    speechRecognizer = null; // Reset the recognizer
                    console.log("Speech recognition stopped.");
                }
            }

            function changeLanguage(event) {
                selectedLanguage = event.target.value; // Update selected language
                console.log("Language changed to:", selectedLanguage);
                stop()
                start();
            }
        </script>
    </head>
    <body>
	<h1>The poor man's STT</h1>
        <div id="result"></div>
        <div class="controls">
            <!-- Language Selection -->
            <select onchange="changeLanguage(event)">
                <option value="en-US" selected>English (US)</option>
                <option value="en-GB">English (UK)</option>
                <option value="es-ES">Spanish (Spain)</option>
                <option value="fr-FR">French (France)</option>
                <option value="de-DE">German (Germany)</option>
                <option value="zh-CN">Chinese (Simplified)</option>
                <option value="ja-JP">Japanese</option>
                <option value="hi-IN">Hindi (India)</option>
            </select>
            <button onclick="start()">Start Listening</button>
            <button onclick="stop()">Stop Listening</button>
        </div>
    </body>
</html>
